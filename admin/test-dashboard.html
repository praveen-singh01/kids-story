<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedtime Stories Admin Dashboard - Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/chart.js"></script>
    <style>
        .card {
            @apply rounded-xl border border-gray-200 bg-white shadow-sm;
        }
        .btn-primary {
            @apply inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                            <span class="text-white font-bold">üåô</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Bedtime Stories</h1>
                            <p class="text-sm text-gray-500">Admin Dashboard</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="refreshBtn" class="btn-primary">
                            Refresh Data
                        </button>
                        <button id="logoutBtn" class="inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium bg-red-600 text-white hover:bg-red-700 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Admin Login</h2>
                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="loginEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="admin@example.com" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="admin123" required>
                    </div>
                    <button type="submit" class="w-full btn-primary">Sign In</button>
                </form>
                <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
            </div>
        </div>

        <!-- Main Content -->
        <main id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Content</p>
                            <p id="totalContent" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-xl">
                            <span class="text-blue-600 text-xl">üìö</span>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Stories</p>
                            <p id="totalStories" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="p-3 bg-green-50 rounded-xl">
                            <span class="text-green-600 text-xl">üìñ</span>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Music</p>
                            <p id="totalMusic" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-xl">
                            <span class="text-purple-600 text-xl">üéµ</span>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Featured</p>
                            <p id="totalFeatured" class="text-2xl font-bold text-gray-900">-</p>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-xl">
                            <span class="text-orange-600 text-xl">‚≠ê</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Content by Type</h3>
                    <canvas id="contentTypeChart" width="400" height="200"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Popularity Distribution</h3>
                    <canvas id="popularityChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Content Table -->
            <div class="card">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Content Management</h2>
                    <p class="text-sm text-gray-600">Manage your stories, music, meditations, and affirmations</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age Range</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Popularity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="contentTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/v1';
        let authToken = localStorage.getItem('admin_token');
        let contentTypeChart = null;
        let popularityChart = null;

        // Check authentication on page load
        function checkAuth() {
            if (authToken) {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadContent();
            } else {
                document.getElementById('loginModal').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
            }
        }

        // Handle login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await axios.post(`${API_BASE}/auth/login`, {
                    email,
                    password
                });

                if (response.data.success && response.data.data.user.roles.includes('admin')) {
                    authToken = response.data.data.accessToken;
                    localStorage.setItem('admin_token', authToken);
                    checkAuth();
                } else {
                    throw new Error('Access denied. Admin privileges required.');
                }
            } catch (error) {
                errorDiv.textContent = error.response?.data?.message || error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // Logout function
        function logout() {
            authToken = null;
            localStorage.removeItem('admin_token');
            checkAuth();
        }

        async function loadContent() {
            try {
                console.log('Loading content from API...');
                const response = await axios.get(`${API_BASE}/explore/list?limit=50`);
                
                if (response.data.success) {
                    const content = response.data.data.content;
                    const pagination = response.data.data.pagination;
                    
                    // Update stats
                    document.getElementById('totalContent').textContent = pagination.total;
                    
                    const stats = content.reduce((acc, item) => {
                        acc[item.type] = (acc[item.type] || 0) + 1;
                        if (item.isFeatured) acc.featured = (acc.featured || 0) + 1;
                        return acc;
                    }, {});
                    
                    document.getElementById('totalStories').textContent = stats.story || 0;
                    document.getElementById('totalMusic').textContent = stats.music || 0;
                    document.getElementById('totalFeatured').textContent = stats.featured || 0;
                    
                    // Update table
                    const tableBody = document.getElementById('contentTable');
                    tableBody.innerHTML = content.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-lg bg-gray-200 flex items-center justify-center">
                                            ${getTypeIcon(item.type)}
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900">${item.title}</div>
                                        <div class="text-sm text-gray-500">${item.slug}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTypeColor(item.type)}">
                                    ${item.type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.ageRange}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDuration(item.durationSec)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.popularityScore}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${item.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${item.isActive ? 'Active' : 'Inactive'}
                                </span>
                                ${item.isFeatured ? '<span class="ml-2 text-yellow-500">‚≠ê</span>' : ''}
                            </td>
                        </tr>
                    `).join('');
                    
                    // Create charts
                    createCharts(content);

                    console.log('Content loaded successfully:', content.length, 'items');
                } else {
                    throw new Error(response.data.message || 'Failed to load content');
                }
            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('contentTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-red-500">
                            Error loading content: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function getTypeIcon(type) {
            const icons = {
                story: 'üìñ',
                music: 'üéµ',
                meditation: 'üßò',
                affirmation: 'üí≠'
            };
            return icons[type] || 'üìÑ';
        }
        
        function getTypeColor(type) {
            const colors = {
                story: 'bg-blue-100 text-blue-800',
                music: 'bg-purple-100 text-purple-800',
                meditation: 'bg-green-100 text-green-800',
                affirmation: 'bg-yellow-100 text-yellow-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }
        
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function createCharts(content) {
            // Content by type chart
            const typeStats = content.reduce((acc, item) => {
                acc[item.type] = (acc[item.type] || 0) + 1;
                return acc;
            }, {});

            if (contentTypeChart) {
                contentTypeChart.destroy();
            }

            const ctx1 = document.getElementById('contentTypeChart').getContext('2d');
            contentTypeChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeStats).map(type => type.charAt(0).toUpperCase() + type.slice(1)),
                    datasets: [{
                        data: Object.values(typeStats),
                        backgroundColor: [
                            '#3B82F6', // Blue
                            '#8B5CF6', // Purple
                            '#10B981', // Green
                            '#F59E0B'  // Orange
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Popularity distribution chart
            const popularityRanges = content.reduce((acc, item) => {
                const score = item.popularityScore;
                if (score >= 90) acc['90-100'] = (acc['90-100'] || 0) + 1;
                else if (score >= 80) acc['80-89'] = (acc['80-89'] || 0) + 1;
                else if (score >= 70) acc['70-79'] = (acc['70-79'] || 0) + 1;
                else if (score >= 60) acc['60-69'] = (acc['60-69'] || 0) + 1;
                else acc['<60'] = (acc['<60'] || 0) + 1;
                return acc;
            }, {});

            if (popularityChart) {
                popularityChart.destroy();
            }

            const ctx2 = document.getElementById('popularityChart').getContext('2d');
            popularityChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(popularityRanges),
                    datasets: [{
                        label: 'Content Count',
                        data: Object.values(popularityRanges),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Load content on page load
        document.addEventListener('DOMContentLoaded', checkAuth);

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadContent);

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', logout);
    </script>
</body>
</html>
